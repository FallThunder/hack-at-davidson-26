(function(){"use strict";const H=/\b(Mr|Mrs|Ms|Dr|Prof|Sr|Jr|vs|etc|U\.S|U\.K|a\.m|p\.m|Jan|Feb|Mar|Apr|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\.\s/g;function M(t){const e=P(t),n=$(t),{text:r,sentences:o}=O(n);return{headline:e,text:r,sentences:o,url:t.location.href,isLikelyArticle:_(t,r)}}function _(t,e){var o;if(((o=t.querySelector('meta[property="og:type"]'))==null?void 0:o.getAttribute("content"))==="article"||t.querySelector('meta[property="article:published_time"]'))return!0;try{const{pathname:s}=new URL(t.location.href);if(s==="/"||s==="")return!1;if(/\/20\d{2}\//.test(s)||/\/\d{7,}(?:\/|$)/.test(s)||/\.(html?)(?:\?|$)/.test(s))return!0;const c=s.split("/").filter(Boolean),l=c[c.length-1]||"";if(l.split("-").length>=4&&l.length>=20)return!0}catch{}return e.trim().split(/\s+/).length>=400}function P(t){const e=["h1",'[itemprop="headline"]','meta[property="og:title"]','meta[name="twitter:title"]'];for(const n of e){const r=t.querySelector(n);if(r){const o=r.tagName==="META"?r.getAttribute("content"):r.innerText;if(o!=null&&o.trim())return o.trim()}}return t.title||""}function $(t){const e=[...t.querySelectorAll('article, [role="main"], main, [itemprop="articleBody"], .article-body, .post-content, .entry-content')];if(e.length===0)return t.body;const n=e.map(r=>{const o=r.innerText||"",c=[...r.querySelectorAll("a")].reduce((i,u)=>{var d;return i+(((d=u.innerText)==null?void 0:d.length)??0)},0),l=o.length>0?c/o.length:1;return{el:r,score:o.length*(1-l)}});return n.sort((r,o)=>o.score-r.score),n[0].el}function O(t){if(!t)return{text:"",sentences:[]};const e=[],n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode(i){var d,a;const u=(a=(d=i.parentElement)==null?void 0:d.tagName)==null?void 0:a.toLowerCase();return["script","style","noscript","nav","header","footer"].includes(u)?NodeFilter.FILTER_REJECT:i.textContent.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let r;for(;r=n.nextNode();)e.push(r.textContent.trim());const o=e.join(" "),l=o.replace(H,i=>i.replace(".","\0")).split(new RegExp(`(?<=[.!?])\\s+(?=[A-Z"'])`,"g")).map(i=>i.replace(/\x00/g,".").trim()).filter(i=>i.length>10).map((i,u)=>({index:u,text:i}));return{text:o,sentences:l}}const x=()=>window.matchMedia("(prefers-reduced-motion: reduce)").matches;let b=[],E=!0,f=null,v=!1,p=null;document.addEventListener("visibilitychange",()=>{document.hidden&&h()});function F(t){return t.replace(/[\u2018\u2019\u02BC]/g,"'").replace(/[\u201C\u201D]/g,'"')}function G(t){return`urgency-${Math.min(Math.max(t,1),5)}`}function q(){return p||(p=document.createElement("div"),p.className="evident-tooltip",document.body.appendChild(p),p)}function B(t,e){const n=q();n.toggleAttribute("data-evident-dark",document.documentElement.hasAttribute("data-evident-dark")),n.textContent=t,n.style.left="-9999px",n.style.top="-9999px",n.style.visibility="visible",n.style.opacity=x()?"1":"0",requestAnimationFrame(()=>{const r=n.offsetWidth,o=n.offsetHeight,s=8;let c=e.left+e.width/2-r/2,l=e.top-o-s;c=Math.max(8,Math.min(c,window.innerWidth-r-8)),l<8&&(l=e.bottom+s),n.style.left=`${c}px`,n.style.top=`${l}px`,n.style.opacity="1"})}function h(){p&&(p.style.opacity="0",p.style.visibility="hidden")}function W(){return f||(f=document.createElement("div"),f.id="evident-popover",document.body.appendChild(f),document.addEventListener("click",S,!0),f)}function R(t,e){const n=b[t];if(!n)return;const r=W(),o=Math.round(n.confidence*100),s=n.sources&&n.sources.length>0?`<div class="evident-pop-sources">
        <p>Sources:</p>
        ${n.sources.map(a=>`<a href="${a.url}" target="_blank" rel="noopener noreferrer">${a.title} — ${a.publisher}</a>`).join("")}
      </div>`:"";r.innerHTML=`
    <div class="evident-pop-header">${n.flag} &mdash; ${o}% confidence</div>
    <blockquote class="evident-pop-excerpt">&ldquo;${n.excerpt}&rdquo;</blockquote>
    <p class="evident-pop-reasoning">${n.reasoning}</p>
    ${s}
  `;const c=240,l=8;let i=e.bottom+window.scrollY+l,u=e.left+window.scrollX;e.bottom+c+l>window.innerHeight&&(i=e.top+window.scrollY-c-l);const d=window.innerWidth-348;u=Math.max(8,Math.min(u,d)),r.style.top=`${i}px`,r.style.left=`${u}px`,r.classList.add("visible"),v=!0}function w(){f&&f.classList.remove("visible"),v=!1}function S(t){if(!v)return;const e=t.target;e.closest(".evident-highlight")||f&&f.contains(e)||w()}function D(t,e){const n=new Set(t),r=new Set(e);let o=0;for(const c of n)r.has(c)&&o++;const s=n.size+r.size-o;return s===0?0:o/s}function T(t){const e=F(t).toLowerCase().replace(/[^a-z0-9\s]/g," "),n=[],r=[],o=/\S+/g;let s;for(;(s=o.exec(e))!==null;)n.push(s[0]),r.push(s.index);return{words:n,offsets:r}}function J(t){const e=[];let n=0;const r=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode(s){var l,i;const c=(i=(l=s.parentElement)==null?void 0:l.tagName)==null?void 0:i.toLowerCase();return c==="script"||c==="style"||c==="noscript"?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let o;for(;o=r.nextNode();){const s=o.textContent.length;s!==0&&(e.length>0&&(n+=1),e.push({node:o,start:n,end:n+s}),n+=s)}return{segments:e,fullText:e.map(s=>s.node.textContent).join(" ")}}function A(t,e){for(const n of t)if(e>=n.start&&e<=n.end)return{node:n.node,offset:e-n.start};return null}function k(t,e,n=.5){const{words:r}=T(e),o=r.length;if(o===0)return null;const{words:s,offsets:c}=T(t.fullText);if(s.length===0)return null;let l=null,i=n-.001;const u=Math.max(3,o-2),d=o+2;for(let a=0;a<s.length;a++)for(let g=u;g<=d&&!(a+g>s.length);g++){const m=D(r,s.slice(a,a+g));if(m>i){i=m;const y=c[a],V=c[a+g-1]+s[a+g-1].length,C=A(t.segments,y),L=A(t.segments,V);C&&L&&(l={startNode:C.node,startOffset:C.offset,endNode:L.node,endOffset:L.offset})}}return l}function U(t,e,n=.5){const r=e.split(/…|\.\.\./).map(c=>c.trim()).filter(c=>T(c).words.length>=2);if(r.length===0)return null;if(r.length===1)return k(t,r[0],n);let o=null,s=0;for(const c of r){const l=k(t,c,n);if(!l)continue;const i=c.trim().split(/\s+/).length;i>s&&(o=l,s=i)}return o}const N={1:"rgba(255, 215, 0, 0.45)",2:"rgba(255, 215, 0, 0.45)",3:"rgba(255, 140, 0, 0.45)",4:"rgba(255, 68, 68, 0.45)",5:"rgba(255, 68, 68, 0.45)"},I={1:"2px dotted #ffd700",2:"2px dotted #ffd700",3:"2px dashed #ff8c00",4:"2px solid #ff4444",5:"3px solid #ff4444"};function z(t){b=t,t.forEach((e,n)=>{if(!e.excerpt)return;const r=J(document.body),o=U(r,e.excerpt);if(!o)return;const s=Math.min(Math.max(e.urgency,1),5),c=`Urgency ${s}/5 — ${e.flag} — ${Math.round(e.confidence*100)}% confidence`,l=()=>{const i=document.createElement("span");return i.className="evident-highlight",i.setAttribute("data-evident-highlight",G(e.urgency)),i.setAttribute("data-evident-flag-index",String(n)),i.style.setProperty("background-color",N[s],"important"),i.style.setProperty("border-bottom",I[s],"important"),i.addEventListener("mouseenter",()=>{E&&B(c,i.getBoundingClientRect())}),i.addEventListener("mouseleave",h),i.addEventListener("auxclick",h),i.addEventListener("contextmenu",h),i.addEventListener("click",u=>{if(!E)return;u.stopPropagation(),h();const d=parseInt(i.getAttribute("data-evident-flag-index"),10);R(d,i.getBoundingClientRect()),chrome.runtime.sendMessage({type:"HIGHLIGHT_CLICKED",flagIndex:d,target:"sidepanel"})}),i};if(o.startNode===o.endNode)try{const i=document.createRange();i.setStart(o.startNode,o.startOffset),i.setEnd(o.endNode,o.endOffset),i.surroundContents(l())}catch{}else{const i=r.segments.findIndex(d=>d.node===o.startNode),u=r.segments.findIndex(d=>d.node===o.endNode);if(i===-1||u===-1)return;for(let d=i;d<=u;d++){const a=r.segments[d],g=d===i?o.startOffset:0,m=d===u?o.endOffset:a.node.textContent.length;if(!(g>=m))try{const y=document.createRange();y.setStart(a.node,g),y.setEnd(a.node,m),y.surroundContents(l())}catch{}}}})}function Y(t){E=t,document.querySelectorAll("[data-evident-highlight]").forEach(e=>{if(t){const n=e.getAttribute("data-evident-highlight"),r=Math.min(Math.max(parseInt(n.replace("urgency-",""),10),1),5);e.style.setProperty("background-color",N[r],"important"),e.style.setProperty("border-bottom",I[r],"important"),e.style.removeProperty("color"),e.style.removeProperty("pointer-events")}else e.style.setProperty("background-color","transparent","important"),e.style.setProperty("border-bottom","none","important"),e.style.setProperty("color","inherit","important"),e.style.setProperty("pointer-events","none","important")}),t||(w(),h())}function j(t){const e=document.querySelectorAll(`[data-evident-flag-index="${t}"]`);e.length&&(e[0].scrollIntoView({behavior:x()?"auto":"smooth",block:"center"}),x()||e.forEach(n=>{n.classList.add("evident-highlight-pulse"),setTimeout(()=>n.classList.remove("evident-highlight-pulse"),1200)}))}function K(){w(),h(),document.querySelectorAll("[data-evident-highlight]").forEach(t=>{const e=t.parentNode;if(e){for(;t.firstChild;)e.insertBefore(t.firstChild,t);e.removeChild(t)}}),b=[],p&&(p.remove(),p=null),f&&(document.removeEventListener("click",S,!0),f.remove(),f=null,v=!1)}chrome.runtime.onMessage.addListener((t,e,n)=>{if(t.type==="GET_ARTICLE"){try{const r=M(document);n(r)}catch{n({headline:document.title,text:"",sentences:[],url:location.href})}return!0}if(t.type==="APPLY_HIGHLIGHTS")return typeof t.dark=="boolean"&&document.documentElement.toggleAttribute("data-evident-dark",t.dark),z(t.highlights||[]),n({success:!0}),!0;if(t.type==="TOGGLE_HIGHLIGHTS")return Y(t.visible),n({success:!0}),!0;if(t.type==="SCROLL_TO_FLAG")return j(t.flagIndex),n({success:!0}),!0;if(t.type==="CLEAR_HIGHLIGHTS")return K(),n({success:!0}),!0;if(t.type==="SET_DARK_MODE")return document.documentElement.toggleAttribute("data-evident-dark",t.dark),n({success:!0}),!0})})();
